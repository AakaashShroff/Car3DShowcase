<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <style>
        body { margin: 0; background-color: #212121; color: #fff; }
        .card { height: 300px; border: 0px solid transparent; position: relative; background-color: #212121; justify-content: center; align-items: center; }
        .card canvas { width: 100%; height: 100%; display: block; background-color: #212121; }
        .model-name { text-align: center; margin-top: 10px; font-size: 1.2em; }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 10;
        }
        .loader-circle {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .owl-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
        }
        .owl-nav button {
            background: transparent;
            border: none;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
        }
        .owl-nav button.owl-prev {
            left: -25px;
        }
        .owl-nav button.owl-next {
            right: -25px;
        }
        .owl-nav button:hover {
            color: #3498db;
        }
        .transparent-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.001); /* Very faint opacity to ensure it covers the card */
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="owl-carousel owl-theme" id="carousel-container"></div>
    </div>
    <script type="module">
        import * as THREE from "https://cdn.skypack.dev/three@0.129.0/build/three.module.js";
        import { OrbitControls } from "https://cdn.skypack.dev/three@0.129.0/examples/jsm/controls/OrbitControls.js";
        import { GLTFLoader } from "https://cdn.skypack.dev/three@0.129.0/examples/jsm/loaders/GLTFLoader.js";

        document.addEventListener("DOMContentLoaded", function () {
            const folders = ['sedan', 'coupe', 'convertible', 'hatchback', 'sport', 'crossover', 'suv']; // Add all your folder names here

            const carouselContainer = document.getElementById('carousel-container');

            folders.forEach(folder => {
                // Create a card for each model
                const cardCol = document.createElement('div');
                cardCol.className = 'item'; // Add item class for OwlCarousel
                carouselContainer.appendChild(cardCol);

                const card = document.createElement('div');
                card.className = 'card';
                cardCol.appendChild(card);

                // Create a transparent overlay for interaction
                const transparentOverlay = document.createElement('div');
                transparentOverlay.className = 'transparent-overlay';
                card.appendChild(transparentOverlay);

                // Create a loading overlay with a loading spinner
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                const loaderCircle = document.createElement('div');
                loaderCircle.className = 'loader-circle';
                loadingOverlay.appendChild(loaderCircle);
                card.appendChild(loadingOverlay);

                // Create a div for the model name
                const modelName = document.createElement('div');
                modelName.className = 'model-name';
                modelName.textContent = folder.charAt(0).toUpperCase() + folder.slice(1);
                cardCol.appendChild(modelName);

                // Create a Three.JS Scene
                const scene = new THREE.Scene();

                // Create a new camera with positions and angles
                const camera = new THREE.PerspectiveCamera(75, card.clientWidth / card.clientHeight, 0.1, 1000);
                camera.position.set(2, 1, 2);

                // Instantiate a new renderer and set its size
                const renderer = new THREE.WebGLRenderer({ alpha: true }); // Alpha: true allows for the transparent background
                renderer.setSize(card.clientWidth, card.clientHeight);

                // Add the renderer to the card
                card.appendChild(renderer.domElement);

                // Add lights to the scene
                const topLight = new THREE.DirectionalLight(0xffffff, 1.5);
                topLight.position.set(0, 10, 10);
                topLight.castShadow = true;
                scene.add(topLight);

                const ambientLight = new THREE.AmbientLight(0x333333, 1);
                scene.add(ambientLight);

                // Add additional lights
                const frontLight = new THREE.DirectionalLight(0xffffff, 0.5);
                frontLight.position.set(10, 0, 10);
                scene.add(frontLight);

                const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
                backLight.position.set(-10, 0, -10);
                scene.add(backLight);

                // Instantiate a loader for the .gltf file
                const gltfLoader = new GLTFLoader();

                // Variable to store the loaded object
                let object;

                // Helper function to convert degrees to radians
                function degreesToRadians(degrees) {
                    return degrees * (Math.PI / 180);
                }

                // Load the file
                gltfLoader.load(
                    `/static/models/${folder}/scene.gltf`,
                    function (gltf) {
                        // If the file is loaded, add it to the scene
                        object = gltf.scene;
                        if (folder === 'hatchback') {
                            object.rotation.y = degreesToRadians(100); // Rotate the hatchback model by 100 degrees
                        }
                        else if (folder === 'crossover') {
                            object.rotation.y = degreesToRadians(180); // Rotate the crossover model by 180 degrees
                        }
                        else if (folder === 'sedan') {
                            object.rotation.y = degreesToRadians(180); 
                            object.position.set(0, 0.25, 0);
                        }
                         else {
                            object.position.set(0, 0, 0);
                        }
                        object.scale.set(0.6, 0.6, 0.6);
                        scene.add(object);
                        // Remove the loading overlay
                        loadingOverlay.style.display = 'none';
                        // Trigger resize to fix initial rendering issue
                        setTimeout(() => {
                            window.dispatchEvent(new Event('resize'));
                        }, 100);
                    },
                    function (xhr) {
                        // While it is loading, log the progress
                        console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                    },
                    function (error) {
                        // If there is an error, log it
                        console.error(error);
                        // Show an error message
                        loadingOverlay.textContent = 'Failed to load';
                    }
                );

                // Add OrbitControls for better camera control
                const controls = new OrbitControls(camera, renderer.domElement);
                controls.target.set(0, 0, 0);

                // Disable all interactions
                controls.enableZoom = false;
                controls.enableRotate = false;
                controls.enablePan = false;

                controls.update();

                // Render the scene
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    if (object) {
                        object.rotation.y += 0.01; // Auto-rotate the object
                    }
                    renderer.render(scene, camera);
                }

                // Add a listener to the window, so we can resize the window and the camera
                window.addEventListener("resize", function () {
                    camera.aspect = card.clientWidth / card.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(card.clientWidth, card.clientHeight);
                });

                // Start the 3D rendering
                animate();
            });

            // Initialize the OwlCarousel with passive event listeners
            $('#carousel-container').owlCarousel({
                loop: false,
                margin: 10,
                nav: true,
                responsive: {
                    0: {
                        items: 1
                    },
                    600: {
                        items: 2
                    },
                    1000: {
                        items: 3
                    }
                }
            });
        });

    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script>
        (function() {
            var supportsPassive = false;
            try {
                var opts = Object.defineProperty({}, 'passive', {
                    get: function() {
                        supportsPassive = true;
                    }
                });
                window.addEventListener('test', null, opts);
            } catch (e) {}
            window.supportsPassive = supportsPassive;
        })();

        const originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if ((type === 'touchstart' || type === 'touchmove') && typeof options === 'object' && !options.passive && !listener.isOrbitControls) {
                options = options || {};
                options.passive = true;
            }
            originalAddEventListener.call(this, type, listener, options);
        };
    </script>
</body>
</html>
